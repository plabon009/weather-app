<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Weather â€¢ Smart Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(145deg, #f0f4ff 0%, #d9e2ff 100%);
            min-height: 100vh;
            padding: 1.5rem;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .app-container {
            max-width: 1100px;
            width: 100%;
            margin: 0 auto;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border-radius: 2rem;
            box-shadow: 0 20px 40px -12px rgba(0, 20, 60, 0.25);
            padding: 2rem;
            border: 1px solid rgba(255,255,255,0.5);
        }

        /* Header */
        .header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo i {
            font-size: 2.5rem;
            color: #3b82f6;
            background: white;
            padding: 0.5rem;
            border-radius: 50%;
            box-shadow: 0 8px 16px -8px #3b82f680;
        }

        .logo h1 {
            font-size: 1.8rem;
            font-weight: 600;
            color: #1e293b;
        }

        .search-area {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            align-items: center;
        }

        .search-box {
            background: white;
            border-radius: 3rem;
            padding: 0.5rem 1rem 0.5rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .search-box i {
            color: #94a3b8;
        }

        .search-box input {
            border: none;
            outline: none;
            font-size: 1rem;
            width: 200px;
        }

        .unit-toggle {
            background: white;
            border-radius: 3rem;
            display: inline-flex;
            padding: 0.25rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }

        .unit-btn {
            border: none;
            background: transparent;
            padding: 0.5rem 1.2rem;
            border-radius: 3rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }

        .unit-btn.active {
            background: #3b82f6;
            color: white;
        }

        /* Status bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            color: #475569;
        }

        .cache-indicator {
            background: #e2e8f0;
            border-radius: 2rem;
            padding: 0.3rem 1rem;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cache-indicator i {
            color: #3b82f6;
        }

        .error-message {
            background: #fee2e2;
            color: #b91c1c;
            border-left: 4px solid #ef4444;
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            display: none;
            align-items: center;
            gap: 1rem;
        }

        .error-message.show {
            display: flex;
        }

        /* Current weather */
        .current-weather {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 1.5rem;
            padding: 1.8rem;
            color: white;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            box-shadow: 0 15px 30px -10px #3b82f6;
        }

        .location h2 {
            font-size: 2.2rem;
            font-weight: 600;
        }

        .date {
            opacity: 0.9;
            margin: 0.3rem 0 0.8rem;
        }

        .condition {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            font-size: 1.3rem;
        }

        .temp-main {
            font-size: 5rem;
            font-weight: 700;
            line-height: 1;
        }

        .details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.2rem;
            margin-top: 1rem;
            width: 100%;
        }

        .detail-item {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(4px);
            border-radius: 1rem;
            padding: 0.8rem 1.2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* Forecast section */
        .forecast-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
        }

        .view-btn {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 2rem;
            padding: 0.5rem 1.2rem;
            cursor: pointer;
            font-weight: 500;
            transition: 0.2s;
        }

        .view-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 1rem;
        }

        .list-view {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .forecast-card {
            background: white;
            border-radius: 1.2rem;
            padding: 1.2rem;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0,0,0,0.04);
        }

        /* Loading */
        .loading-overlay {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(255,255,255,0.6);
            backdrop-filter: blur(4px);
            border-radius: 2rem;
            justify-content: center;
            align-items: center;
            z-index: 10;
        }

        .loading-overlay.show {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        footer {
            text-align: center;
            margin-top: 2rem;
            color: #475569;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
<div class="app-container">
    <div class="glass-card" style="position: relative;">

        <!-- Loading overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="spinner"></div>
        </div>

        <!-- Header -->
        <div class="header">
            <div class="logo">
                <i class="fas fa-cloud-sun"></i>
                <h1>SmartWeather</h1>
            </div>
            <div class="search-area">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="cityInput" placeholder="City name" value="Dhaka">
                </div>
                <div class="unit-toggle" id="unitToggle">
                    <button class="unit-btn active" data-unit="metric">Â°C</button>
                    <button class="unit-btn" data-unit="imperial">Â°F</button>
                </div>
            </div>
        </div>

        <!-- Status & cache info -->
        <div class="status-bar">
            <div class="cache-indicator" id="cacheInfo">
                <i class="fas fa-database"></i>
                <span id="cacheText">Live data</span>
            </div>
            <button id="refreshBtn" class="view-btn" style="background:white;">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>

        <!-- Error message -->
        <div id="errorMessage" class="error-message">
            <i class="fas fa-exclamation-circle"></i>
            <span id="errorText"></span>
        </div>

        <!-- Current weather -->
        <div id="currentWeather" class="current-weather">
            <!-- dynamically filled -->
        </div>

        <!-- Forecast section -->
        <div class="forecast-header">
            <h3 style="font-size:1.4rem;">5â€‘Day Forecast</h3>
            <div class="view-toggle" id="viewToggle">
                <button class="view-btn active" data-view="chart">ðŸ“ˆ Chart</button>
                <button class="view-btn" data-view="list">ðŸ“‹ List</button>
            </div>
        </div>

        <!-- Chart view -->
        <div id="chartView" class="chart-container">
            <canvas id="forecastChart"></canvas>
        </div>

        <!-- List view -->
        <div id="listView" class="list-view"></div>

        <footer>
            <p>âš¡ Preferences saved in your browser â€¢ Smart cache â€¢ Graceful error handling</p>
        </footer>
    </div>
</div>

<script>
    (function() {
        // ---------- Configuration ----------
        const API_KEY = 'a3d9eb01d4de82b9b8d0849ef604dbed';   // Replace with your key
        const BASE_URL = 'https://api.openweathermap.org/data/2.5';

        // DOM elements
        const cityInput = document.getElementById('cityInput');
        const unitBtns = document.querySelectorAll('.unit-btn');
        const viewBtns = document.querySelectorAll('[data-view]');
        const chartView = document.getElementById('chartView');
        const listView = document.getElementById('listView');
        const currentWeatherDiv = document.getElementById('currentWeather');
        const errorDiv = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const cacheInfo = document.getElementById('cacheText');
        const refreshBtn = document.getElementById('refreshBtn');
        const ctx = document.getElementById('forecastChart').getContext('2d');

        // ---------- State ----------
        let currentUnit = 'metric';           // 'metric' or 'imperial'
        let currentCity = 'Dhaka';
        let chartInstance = null;

        // Cache (inâ€‘memory + localStorage for preferences)
        let lastFetchCity = '';
        let lastFetchUnit = '';
        let cachedWeather = null;              // current weather data
        let cachedForecast = null;              // forecast list

        // ---------- localStorage ----------
        function loadPreferences() {
            const savedCity = localStorage.getItem('pref_city');
            const savedUnit = localStorage.getItem('pref_unit');
            if (savedCity) {
                currentCity = savedCity;
                cityInput.value = savedCity;
            }
            if (savedUnit && (savedUnit === 'metric' || savedUnit === 'imperial')) {
                currentUnit = savedUnit;
                updateUnitButtons();
            }
        }

        function savePreferences() {
            localStorage.setItem('pref_city', currentCity);
            localStorage.setItem('pref_unit', currentUnit);
        }

        function updateUnitButtons() {
            unitBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.unit === currentUnit);
            });
        }

        // ---------- UI Helpers ----------
        function showLoading() {
            loadingOverlay.classList.add('show');
        }

        function hideLoading() {
            loadingOverlay.classList.remove('show');
        }

        function showError(message) {
            errorText.textContent = message;
            errorDiv.classList.add('show');
        }

        function hideError() {
            errorDiv.classList.remove('show');
        }

        function updateCacheInfo(usedCache) {
            cacheInfo.textContent = usedCache ? 'Cached data' : 'Live data';
        }

        // ---------- Data fetching with conditional strategy ----------
        async function fetchWeatherData(forceRefresh = false) {
            // Check if we already have cached data for same city & unit
            const city = currentCity.trim();
            if (!city) {
                showError('Please enter a city name.');
                return;
            }

            // If not forced refresh and we have cached data for same city/unit, use it
            if (!forceRefresh && lastFetchCity === city && lastFetchUnit === currentUnit && cachedWeather && cachedForecast) {
                console.log('Using cached data');
                updateCacheInfo(true);
                displayCurrentWeather(cachedWeather);
                processForecast(cachedForecast);
                hideError();
                return;
            }

            // Otherwise fetch new data
            showLoading();
            hideError();
            updateCacheInfo(false);

            try {
                const weatherUrl = `${BASE_URL}/weather?q=${city}&units=${currentUnit}&appid=${API_KEY}`;
                const forecastUrl = `${BASE_URL}/forecast?q=${city}&units=${currentUnit}&appid=${API_KEY}`;

                const [weatherRes, forecastRes] = await Promise.all([
                    fetch(weatherUrl),
                    fetch(forecastUrl)
                ]);

                // Handle specific HTTP errors
                if (!weatherRes.ok) {
                    if (weatherRes.status === 404) throw new Error(`City "${city}" not found.`);
                    if (weatherRes.status === 401) throw new Error('Invalid API key. Please check your key.');
                    if (weatherRes.status === 429) throw new Error('Rate limit exceeded. Please try later.');
                    throw new Error(`Weather API error: ${weatherRes.status}`);
                }

                if (!forecastRes.ok) {
                    throw new Error(`Forecast API error: ${forecastRes.status}`);
                }

                const weatherData = await weatherRes.json();
                const forecastData = await forecastRes.json();

                // Update cache
                cachedWeather = weatherData;
                cachedForecast = forecastData;
                lastFetchCity = city;
                lastFetchUnit = currentUnit;

                // Save city to localStorage (preference)
                currentCity = city;
                savePreferences();

                // Update UI
                displayCurrentWeather(weatherData);
                processForecast(forecastData);
            } catch (error) {
                console.error('Fetch error:', error);
                showError(error.message);
                // Optionally fall back to cached data if available
                if (cachedWeather && cachedForecast) {
                    displayCurrentWeather(cachedWeather);
                    processForecast(cachedForecast);
                    updateCacheInfo(true);
                } else {
                    // Clear previous content
                    currentWeatherDiv.innerHTML = '<p style="color:white;">No data available</p>';
                }
            } finally {
                hideLoading();
            }
        }

        // ---------- Display current weather ----------
        function displayCurrentWeather(data) {
            const tempUnit = currentUnit === 'metric' ? 'Â°C' : 'Â°F';
            const speedUnit = currentUnit === 'metric' ? 'km/h' : 'mph';
            const windSpeed = currentUnit === 'metric'
                ? Math.round(data.wind.speed * 3.6)
                : Math.round(data.wind.speed * 2.237);

            const date = new Date().toLocaleDateString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            const iconClass = getWeatherIcon(data.weather[0].icon);

            currentWeatherDiv.innerHTML = `
                <div style="flex:1;">
                    <h2>${data.name}, ${data.sys.country}</h2>
                    <div class="date">${date}</div>
                    <div class="condition">
                        <i class="${iconClass}"></i>
                        <span>${data.weather[0].description}</span>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div class="temp-main">${Math.round(data.main.temp)}${tempUnit}</div>
                    <div>Feels like ${Math.round(data.main.feels_like)}${tempUnit}</div>
                </div>
                <div class="details">
                    <div class="detail-item"><i class="fas fa-droplet"></i> <span>${data.main.humidity}%</span></div>
                    <div class="detail-item"><i class="fas fa-wind"></i> ${windSpeed} ${speedUnit}</div>
                    <div class="detail-item"><i class="fas fa-compress-alt"></i> ${data.main.pressure} hPa</div>
                    <div class="detail-item"><i class="fas fa-eye"></i> ${(data.visibility/1000).toFixed(1)} km</div>
                </div>
            `;
        }

        // ---------- Process forecast (for chart & list) ----------
        function processForecast(data) {
            // Group by day (simple: take one per day at 12:00)
            const dailyMap = new Map();
            data.list.forEach(item => {
                const date = new Date(item.dt * 1000).toLocaleDateString('en-US', { weekday: 'short', month:'short', day:'numeric' });
                if (!dailyMap.has(date)) {
                    dailyMap.set(date, {
                        max: item.main.temp_max,
                        min: item.main.temp_min,
                        icon: item.weather[0].icon,
                        desc: item.weather[0].description
                    });
                } else {
                    const existing = dailyMap.get(date);
                    existing.max = Math.max(existing.max, item.main.temp_max);
                    existing.min = Math.min(existing.min, item.main.temp_min);
                }
            });

            const labels = [...dailyMap.keys()].slice(0,5);
            const maxTemps = labels.map(d => Math.round(dailyMap.get(d).max));
            const minTemps = labels.map(d => Math.round(dailyMap.get(d).min));
            const icons = labels.map(d => dailyMap.get(d).icon);
            const descs = labels.map(d => dailyMap.get(d).desc);

            updateChart(labels, maxTemps, minTemps);
            updateListView(labels, maxTemps, minTemps, icons, descs);
        }

        function updateChart(labels, maxTemps, minTemps) {
            if (chartInstance) chartInstance.destroy();

            const tempUnit = currentUnit === 'metric' ? 'Â°C' : 'Â°F';
            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: `Max (${tempUnit})`, data: maxTemps, borderColor: '#ef4444', backgroundColor: 'transparent', tension:0.3, pointBackgroundColor:'#ef4444' },
                        { label: `Min (${tempUnit})`, data: minTemps, borderColor: '#10b981', backgroundColor: 'transparent', tension:0.3, pointBackgroundColor:'#10b981' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { tooltip: { mode:'index', intersect:false } }
                }
            });
        }

        function updateListView(labels, maxTemps, minTemps, icons, descs) {
            const tempUnit = currentUnit === 'metric' ? 'Â°C' : 'Â°F';
            listView.innerHTML = labels.map((date,i) => `
                <div class="forecast-card">
                    <div style="font-weight:600;">${date.split(',')[0]}</div>
                    <div style="font-size:0.8rem; color:#64748b;">${date.split(',').slice(1).join(',')}</div>
                    <i class="${getWeatherIcon(icons[i])}" style="font-size:2rem; margin:0.5rem 0;"></i>
                    <div><span style="color:#ef4444;">${maxTemps[i]}${tempUnit}</span> / <span style="color:#10b981;">${minTemps[i]}${tempUnit}</span></div>
                    <div style="font-size:0.8rem; color:#64748b;">${descs[i]}</div>
                </div>
            `).join('');
        }

        // Weather icon mapping
        function getWeatherIcon(iconCode) {
            const map = {
                '01d':'fas fa-sun','01n':'fas fa-moon',
                '02d':'fas fa-cloud-sun','02n':'fas fa-cloud-moon',
                '03d':'fas fa-cloud','03n':'fas fa-cloud',
                '04d':'fas fa-cloud','04n':'fas fa-cloud',
                '09d':'fas fa-cloud-rain','09n':'fas fa-cloud-rain',
                '10d':'fas fa-cloud-sun-rain','10n':'fas fa-cloud-moon-rain',
                '11d':'fas fa-cloud-bolt','11n':'fas fa-cloud-bolt',
                '13d':'fas fa-snowflake','13n':'fas fa-snowflake',
                '50d':'fas fa-smog','50n':'fas fa-smog'
            };
            return map[iconCode] || 'fas fa-cloud';
        }

        // ---------- View toggle ----------
        function setView(view) {
            viewBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
            if (view === 'chart') {
                chartView.style.display = 'block';
                listView.style.display = 'none';
            } else {
                chartView.style.display = 'none';
                listView.style.display = 'grid';
            }
        }

        // ---------- Event listeners ----------
        cityInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                currentCity = cityInput.value.trim();
                fetchWeatherData(true);  // force refresh on explicit search
            }
        });

        unitBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const newUnit = btn.dataset.unit;
                if (newUnit === currentUnit) return;
                currentUnit = newUnit;
                updateUnitButtons();
                savePreferences();
                // If we have cached data for the new unit? No, different unit requires new fetch.
                // But we can fetch without force if city same
                fetchWeatherData(false);
            });
        });

        refreshBtn.addEventListener('click', () => {
            fetchWeatherData(true);
        });

        viewBtns.forEach(btn => {
            btn.addEventListener('click', () => setView(btn.dataset.view));
        });

        // ---------- Initialisation ----------
        loadPreferences();
        setView('chart');
        // Try to load from cache on startup
        fetchWeatherData(false).then(() => {
            // Ensure we save preferences after first successful load
            savePreferences();
        });
    })();
</script>
</body>
</html>